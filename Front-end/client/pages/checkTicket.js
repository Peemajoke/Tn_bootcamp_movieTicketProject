import Head from "next/head";
import React, { useState } from "react";
import Navbar from "../components/navbar";
import Footer from "../components/Footer";
import { AudioOutlined } from "@ant-design/icons";
import { Input, Space, Descriptions, Modal } from "antd";
import { useMutation, useLazyQuery, gql } from "@apollo/client";

const { Search } = Input;

const suffix = (
  <AudioOutlined
    style={{
      fontSize: 16,
      color: "#1890ff",
    }}
  />
);

const getTicketByRef_num = gql`
query($ref_num: String!) {
  getTicketByID(ref_num: $ref_num) {
    data {
      _id
      ref_num
      email
      movie
      theater
      dateTime
      seat
      price
    }
  }
}
`;

function checkTicket(props) {
  const [ref_num, setRef_num] = useState("");
  const [isSearchOnce, setIsSearchOnce] = useState(false);

  const [getTicket,{ loading, data }] = useLazyQuery(getTicketByRef_num);

  const onSearch = async () => {

    if(ref_num==""){
      Modal.warning({
        title: 'Cannot perform this search!',
        content: `A ticket's reference code must be provide to perform a search.`,
      });
    }
    
    console.log(ref_num);
    await getTicket({ variables: { ref_num: ref_num }})
    // console.log('fetch result:', data)
    // console.log('fetch result:', data.getTicketByID)
    // console.log('fetch movie:', data.getTicketByID.data.movie)
    setIsSearchOnce(true)
    console.log('isSearch: ', isSearchOnce)
  };

  const showTicketDetail = () => {
    if (data!==undefined){
      return (<Descriptions title="Ticket Info">
      <Descriptions.Item label="ref_num">{data.getTicketByID.data.ref_num}</Descriptions.Item>
      <Descriptions.Item label="Movie">{data.getTicketByID.data.movie}</Descriptions.Item>
      <Descriptions.Item label="Theater">{data.getTicketByID.data.theater}</Descriptions.Item>
      <Descriptions.Item label="Show Time">{data.getTicketByID.data.dateTime.slice(11,16)}</Descriptions.Item>
      <Descriptions.Item label="Seat">{data.getTicketByID.data.seat}</Descriptions.Item>
    </Descriptions>)
    }else return null
  }

  return (
    <>
      <Head>
        <title>S Major F: Check Ticket</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Navbar />

      <h1>Check For Ticket Information</h1>
      <Search
        placeholder="type ticket's ref_number"
        allowClear
        onSearch={onSearch}
        style={{ width: 300 }}
        onChange={(e) => setRef_num(e.target.value)}
      />
      <br />
      {/* {loading&&<p>loading...</p>} */}
      {isSearchOnce&&data&&data.getTicketByID==null&&<p>Sorry, there is no ticket you are looking for.</p>}
      {isSearchOnce&&data&&data.getTicketByID!=null&&showTicketDetail()}
      <Footer />
    </>
  );
}

export default checkTicket;
